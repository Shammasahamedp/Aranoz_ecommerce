<% include('../partials/header.ejs') %>

  <!-- Include Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

  <!-- Include SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <!-- Include Cropper.js CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">

  <!-- Your custom CSS -->
  <link rel="stylesheet" href="/css/admindashboard.css">

  <style>
    input::placeholder,
    textarea::placeholder {
      color: rgb(147, 145, 145);
    }

    .form-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .image-group {
  text-align: center; 
  margin: 10px; 
}

.image-group img {
  display: block; 
  margin: 0 auto; 
}

.image-group button {
  margin-top: 10px;
  display: block;
  width: 100%;
}
  </style>

  <div class="container-scroller">
    <!-- partial:partials/_navbar.html -->
    <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row" style="background-color: #6a008a;">
      <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center"
        style="background-color: #6a008a;">
        <div style="background-color: #6a008a;">Purple</div>
      </div>
      <div class="navbar-menu-wrapper d-flex align-items-stretch">
        <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button"
          data-toggle="offcanvas">
          <span class="mdi mdi-menu"></span>
        </button>
      </div>
    </nav>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <div class="row row-offcanvas row-offcanvas-right">
        <!-- partial:partials/_sidebar.html -->
        <nav class="sidebar sidebar-offcanvas" id="sidebar">
          <ul class="nav">
            <li class="nav-item">
              <a class="nav-link" href="/admin/dashboard">
                <span class="menu-title">Dashboard</span>
                <span class="menu-sub-title">( 2 new updates )</span>
                <i class="mdi mdi-home menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="collapse" href="/admin/users" aria-expanded="false" aria-controls="ui-basic">
                <span class="menu-title">Users</span>
                <i class="menu-arrow"></i>
                <i class="mdi mdi-crosshairs-gps menu-icon"></i>
              </a>
             
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/products">
                <span class="menu-title">Products</span>
                <i class="mdi mdi-contacts menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/categories">
                <span class="menu-title">Categories</span>
                <i class="mdi mdi-format-list-bulleted menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/orders">
                <span class="menu-title">Orders</span>
                <i class="mdi mdi-chart-bar menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/coupons">
                <span class="menu-title">Coupons</span>
                <i class="mdi mdi-table-large menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/offers">
                <span class="menu-title">Offers</span>
                <i class="mdi mdi-table-large menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/salesreport">
                <span class="menu-title">Sales Report</span>
                <i class="mdi mdi-table-large menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="collapse" href="/admin/logout" aria-expanded="false" aria-controls="auth">
                <span class="menu-title">Logout</span>
                <i class="menu-arrow"></i>
                <i class="mdi mdi-lock menu-icon"></i>
              </a>
              
            </li>
          </ul>
         
         
         
        </nav>
        <!-- partial -->
        <div class="content-wrapper">
          <!-- Add the form for adding a new product -->
          <div class="card-body">
            <div class="form-container">
              <h4 class="card-title">Add Product</h4>
              <form id="productAddForm" enctype="multipart/form-data">
                <!-- Name Field -->
                <div class="form-group">
                  <label for="productName">Name</label>
                  <input type="text" id="productName" name="name" class="form-control" placeholder="Enter product name"
                    required>
                  <div id="validateName" class="text-danger"></div>
                </div>
                <!-- Upload Button -->
                <div id="imagecontainer" style="display: flex; justify-content: space-between;">
                  <div class="image-group">
                   

                    <img src="" alt="" id="currentimage1" style="width: 100px; height: 100px; object-fit: cover;">
                    <input type="file" accept="image/png, image/jpeg" id="uploadimage1" style="display: none;">
                    <button type="button" class="btn btn-primary uploadButton mt-1" id="uploadbutton1">Upload Image 1</button>
                    <div class="text-danger" id="imagevalid1" style="display: none;">not every file accepted</div>
                  </div>
                    
                  <div class="image-group">
                    <img src="" alt="" id="currentimage2" style="width: 100px; height: 100px; object-fit: cover;">
                    <input type="file" accept="image/png, image/jpeg" id="uploadimage2" style="display: none;">
                    <button type="button" class="btn btn-primary uploadButton mt-1" id="uploadbutton2">Upload Image 2</button>
                    <div class="text-danger" id="imagevalid2" style="display: none;">not every file accepted</div>
                  </div>
                  
                  <div class="image-group">
                    <img src="" alt="" id="currentimage3" style="width: 100px; height: 100px; object-fit: cover;">
                    <input type="file" accept="image/png, image/jpeg" id="uploadimage3" style="display: none;">
                    <button type="button" class="btn btn-primary uploadButton mt-1" id="uploadbutton3">Upload Image 3</button>
                    <div class="text-danger" id="imagevalid3" style="display: none;">not every file accepted</div>
                  </div>
                  <!-- Add more as needed -->
                </div>


                <!-- Category Field -->
                <div class="form-group">
                  <label for="productCategory">Category</label>
                  <select name="category" id="productCategory" class="form-control" required>
                    <option value="">Select category</option>
                    <% categories.forEach(function(category) { %>
                      <option value="<%= category._id %>">
                        <%= category.name %>
                      </option>
                      <% }); %>
                  </select>
                  <div id="validateCategory" class="text-danger"></div>
                </div>
                <!-- Price Field -->
                <div class="form-group">
                  <label for="productPrice">Price</label>
                  <input type="number" id="productPrice" name="price" class="form-control"
                    placeholder="Enter product price" required>
                  <div id="validateStock" class="text-danger"></div>
                </div>
                <!-- Quantity Field -->
                <div class="form-group">
                  <label for="productQuantity">Stock</label>
                  <input type="number" id="productQuantity" name="quantity" class="form-control"
                    placeholder="Enter product quantity" required>
                  <div id="validatePrice" class="text-danger"></div>
                </div>
                <div id="specificationContainer">
                  <label for="productSpec">Specification</label>
                  <div class="form-group row specification-entry">
                    <div class="col-md-5">
                      <input type="text" name="specifications[0][key]" class="form-control"
                        placeholder="Specification Key" >
                    </div>
                    <div class="col-md-5">
                      <input type="text" name="specifications[0][value]" class="form-control"
                        placeholder="Specification Value" >
                    </div>

                  </div>
                </div>

                <div class="col-12 text-center mt-3">
                  <button type="button" class="btn btn-primary mb-3" id="addSpecificationButton">Add Another
                    Specification</button>
                    <!-- onclick="addSpecification() -->
                </div>
                <!-- Save Button -->
                <div class="col-12 text-center">
                  <button type="submit" class="btn btn-primary">Add Product</button>
                  <button class="btn btn-primary">
                    <a href="/admin/products" style="color: white;">Back</a>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

      </div>
      <!-- row-offcanvas ends -->
    </div>
    <!-- page-body-wrapper ends -->
  </div>

  <!-- Modal for Cropping -->
  <div class="modal fade" id="cropModal" tabindex="-1" role="dialog" aria-labelledby="cropModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cropModalLabel">Crop Image</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <img id="imageToCrop" src="" alt="Image to crop" style="max-width: 100%;">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" id="cropAndSave" class="btn btn-primary">Crop & Save</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    
    document.addEventListener('DOMContentLoaded', () => {
      let specCount = 0
      
    async function addSpecification() {
      console.log('button clicked')
      specCount++
      const container = document.getElementById('specificationContainer')
      // console.log(container)
      const newSpecification = document.createElement('div')
      newSpecification.classList.add('form-group', 'row', 'specification-entry')
      newSpecification.innerHTML = `
      <div class="col-md-5">
                          <input type="text" name="specifications[${specCount}][key]" class="form-control" placeholder="Specification Key" required>
                      </div>
                      <div class="col-md-5">
                          <input type="text" name="specifications[${specCount}][value]" class="form-control" placeholder="Specification Value" required>
                      </div>
                      <div class="col-md-2 text-center">
                <button type="button" class="btn btn-danger btn-sm remove-specification">Remove</button>
            </div>
    `
      container.appendChild(newSpecification)
    }
    document.getElementById('addSpecificationButton').addEventListener('click',async (event)=>{
      event.preventDefault()
      addSpecification()
    })
    let cropper;
  const modal = $('#cropModal');
  const imageToCrop = document.getElementById('imageToCrop');
  const uploadButtons = document.querySelectorAll('.uploadButton');
  const uploadInputs = document.querySelectorAll('input[type="file"]');

  let currentImage;
  let croppedImages = [];
   
  // Initialize oldCroppedImages with the current state of the images
  let oldCroppedImages = Array.from(document.querySelectorAll('#imagecontainer img')).map(img => img.src);
      croppedImages=[...oldCroppedImages]
  uploadButtons.forEach((button, index) => {
    button.addEventListener('click', () => {
      uploadInputs[index].click();
    });
    
    uploadInputs[index].addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          imageToCrop.src = reader.result;
          currentImage = document.getElementById(`currentimage${index + 1}`);
          modal.modal('show');
        };
        reader.readAsDataURL(file);
      }
    });
  });

  modal.on('shown.bs.modal', () => {
    cropper = new Cropper(imageToCrop, {
      aspectRatio: 1,
      viewMode: 2,
      preview: '.preview',
    });
  }).on('hidden.bs.modal', () => {
    cropper.destroy();
    cropper = null;
  });

  document.getElementById('cropAndSave').addEventListener('click', () => {
    const canvas = cropper.getCroppedCanvas({
      width: 500,
      height: 500,
    });

    const croppedImageDataURL = canvas.toDataURL();
    currentImage.src = croppedImageDataURL;

    const index = Array.from(uploadButtons).indexOf(currentImage.closest('.image-group').querySelector('.uploadButton'));
    croppedImages[index] = croppedImageDataURL;

    modal.modal('hide');
  });
   
   const container= document.getElementById('specificationContainer')
  //  console.log(container)
   container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-specification')) {
            e.target.closest('.specification-entry').remove();
        }
    });
     const form=document.getElementById('productAddForm')
     form.addEventListener('submit', async function (event) {
      
      // console.log('inside',container)
      event.preventDefault();
      // console.log('button has clicked')
      const  name = document.getElementById('productName').value.trim();
     
      // console.log(name)
      const category = document.getElementById('productCategory').value.trim();
     
      const price = document.getElementById('productPrice').value;
     
      const stock = document.getElementById('productQuantity').value;
      // stock=stock.value
      // console.log(stock)
      let validName = /^(?=.*\S)(?=\D*$).*$/.test(name);
      let validPrice = /^(?!0+$)\d+$/.test(price.toString());
      let validStock = /^\d+$/.test(stock.toString());
      
      // const container = document.getElementById('specificationContainer')
      // console.log(container,'sdfgjhadpifhpaidhfgkp')
      const specificationEntries=container.querySelectorAll('.specification-entry')
     console.log(specificationEntries)
      const keyValuePairs=[]
      specificationEntries.forEach(entry=>{
        console.log(entry)
        let key=entry.querySelector('input[placeholder="Specification Key"]').value.trim()
        let value=entry.querySelector('input[placeholder="Specification Value"]').value.trim()
        //  key=key.value.trim()
        //  value=value.trim()
        // console.log(key)
        keyValuePairs.push({key:key,value:value})
      })
      // console.log(keyValuePairs)
      document.getElementById('validateName').innerText = '';
      if (!validName) {
        document.getElementById('validateName').innerText = 'Name is not valid';
        return;
      }
      document.getElementById('validatePrice').innerText = '';
      if (!validPrice) {
        document.getElementById('validatePrice').innerText = 'Price is not valid';
        return;
      }
      document.getElementById('validateStock').innerText = '';
      if (!validStock) {
        document.getElementById('validateStock').innerText = 'stock is not valid';
        return;
      }
      console.log('this is key value pairs',keyValuePairs)
      const specifications=JSON.stringify(keyValuePairs)
      console.log('this is specification',specifications)
      const formData = new FormData();
      formData.append('name', name);
      formData.append('category', category);
      formData.append('price', price);
      formData.append('stock', stock);
      formData.append('specifications',specifications)
      for (let i = 0; i < croppedImages.length; i++) {
        if (croppedImages[i]) {
          const response = await fetch(croppedImages[i]);
          const blob = await response.blob();
          formData.append('imageUrl', blob, `image${i + 1}.png`);
        }
      }
      try {
        const response = await fetch('/admin/products/addproduct', {
          method: 'POST',
          body: formData,
        });

        if (response.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Product added successfully!',
            showConfirmButton: false,
            timer: 1500
          }).then(() => {
            window.location.href = '/admin/products';
          });
        } else {
          console.log('already exists')
          const errorText = await response.json();
          Swal.fire({
            
            title: 'Failed',
            text: errorText.message,
            icon: 'error',
            confirmButtonText:'OK'
          });
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: error.message,
          text: 'Please try again later.',
        });
      }
    });
  });

  </script>
  <!-- Include jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- Include Bootstrap JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

  <!-- Include SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Include Cropper.js JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

  <!-- <script src="/js/adminProductsAddScript.js"> -->

  </script>

  <% include('../partials/footer.ejs') %>