<% include ('../usersidepartials/header')%>

    <title>aranoz|checkout</title>
    <link rel="icon" href="/img/favicon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Toastify JS -->


    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/usercss/bootstrap.min.css">
    <!-- animate CSS -->
    <link rel="stylesheet" href="/css/usercss/animate.css">
    <!-- owl carousel CSS -->
    <link rel="stylesheet" href="/css/usercss/owl.carousel.min.css">
    <!-- nice select CSS -->
    <link rel="stylesheet" href="/css/usercss/nice-select.css">
    <!-- font awesome CSS -->
    <link rel="stylesheet" href="/css/usercss/all.css">
    <!-- flaticon CSS -->
    <link rel="stylesheet" href="/css/usercss/flaticon.css">
    <link rel="stylesheet" href="/css/usercss/themify-icons.css">
    <!-- font awesome CSS -->
    <link rel="stylesheet" href="/css/usercss/magnific-popup.css">
    <!-- swiper CSS -->
    <link rel="stylesheet" href="/css/usercss/slick.css">
    <link rel="stylesheet" href="/css/usercss/price_rangs.css">
    <!-- style CSS -->
    <link rel="stylesheet" href="/css/usercss/style.css">
    </head>

    <body>
        <!--::header part start::-->
        <header class="main_menu home_menu">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-12">
                        <nav class="navbar navbar-expand-lg navbar-light">
                            <a class="navbar-brand" href="index.html"> <img src="/img/logo.png" alt="logo"> </a>
                            <button class="navbar-toggler" type="button" data-toggle="collapse"
                                data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                                aria-expanded="false" aria-label="Toggle navigation">
                                <span class="menu_icon"><i class="fas fa-bars"></i></span>
                            </button>

                            <div class="collapse navbar-collapse main-menu-item" id="navbarSupportedContent">
                                <ul class="navbar-nav">
                                    <li class="nav-item">
                                        <a class="nav-link" href="/user/dashboard">Dashboard</a>
                                    </li>
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" href="blog.html" id="navbarDropdown_1"
                                            role="button" data-toggle="dropdown" aria-haspopup="true"
                                            aria-expanded="false">
                                            Shop
                                        </a>
                                        <div class="dropdown-menu" aria-labelledby="navbarDropdown_1">
                                            <a class="dropdown-item" href="/home/shopcategory"> shop category</a>
                                            <!-- <a class="dropdown-item" href="single-product.html">product details</a> -->

                                        </div>
                                    </li>
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" href="blog.html" id="navbarDropdown_3"
                                            role="button" data-toggle="dropdown" aria-haspopup="true"
                                            aria-expanded="false">
                                            Profile
                                        </a>
                                        <div class="dropdown-menu" aria-labelledby="navbarDropdown_2">
                                            <!-- <a class="dropdown-item" href="/user/dashboard/profile"> Profile</a> -->
                                            <a class="dropdown-item" href="/user/dashboard/profile/address">Address</a>
                                            <a class="dropdown-item" href="/user/dashboard/profile/wishlist">Wishlist
                                            </a>
                                            <a class="dropdown-item" href="/user/dashboard/profile/wallet">Wallet</a>
                                            <a class="dropdown-item" href="/user/dashboard/profile/orders">Orders</a>
                                            <a class="dropdown-item" href="/user/coupons">Coupons</a>
                                            <a class="dropdown-item" onclick="logout()">Logout</a>

                                        </div>
                                    </li>

                                    <li class="nav-item">
                                        <a class="nav-link" href="/contact">Contact</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="hearer_icon d-flex">
                                <a id="search_1" href="javascript:void(0)"><i class="bi bi-search"></i></a>
                                <a href=""><i class="bi bi-heart"></i></a>
                                <div class="dropdown cart">
                                    <a class="dropdown-toggle" href="#" id="navbarDropdown3" role="button"
                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="bi bi-cart"></i>
                                    </a>
                                    <!-- <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                <div class="single_product">

                                </div>
                            </div> -->

                                </div>
                            </div>
                        </nav>
                    </div>
                </div>
            </div>

        </header>
        <!-- Header part end-->

        <!--================Home Banner Area =================-->
        <!-- breadcrumb start-->
        <section class="breadcrumb breadcrumb_bg">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="breadcrumb_iner">
                            <div class="breadcrumb_iner_item">
                                <h2>Products Checkout</h2>
                                <p><a href="/user/dashboard">Dashboard</a> <span>-</span><a href="/user/cart">Cart</a>
                                    <span>-</span>Checkout
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- breadcrumb start-->

        <!--================Checkout Area =================-->
        <section class="checkout_area padding_top">
            <div class="container">

                <div class="cupon_area">
                    <div class="check_title">
                        <h2>
                            Have a coupon?
                            <a href="/user/coupons">Click here to see your available coupon</a>
                        </h2>
                    </div>
                    <input type="text" id="coupon" value="" placeholder="Enter coupon code" />
                    <div class="text-danger" id="couponValidation"></div>
                    <a class="tp_btn" onclick="applyCoupon('<%=cartData.totalPrice%>')">Apply Coupon</a>
                </div>

                <div class="billing_details">
                    <div class="row">
                        <div class="col-lg-7">
                            <%if(addresses){%>
                                <h3>Select Addresses</h3>
                                <div class="row" id="addresslist">
                                    <% if(addresses){ %>
                                        <% addresses.address.forEach(function(address, index) { %>
                                            <div class="col-md-6">
                                                <script>

                                                </script>
                                                <div class="address-item mb-3 d-flex align-items-start">
                                                    <input type="radio" name="selectedAddress"
                                                        data-id="<%= address._id %>" id="address<%= index %>"
                                                        class="mr-2" data-id="<%=address._id%>"
                                                        data-name="<%=address.name%>" data-phone="<%=address.phone%>"
                                                        data-email="<%=address.email%>" data-city="<%=address.city%>"
                                                        data-district="<%=address.district%>"
                                                        data-state="<%=address.state%>"
                                                        data-pin="<%=address.pincode%>">
                                                    <textarea class="form-control" rows="3" style="height: 200px;"
                                                        readonly>
                        Name: <%= address.name %>, 
                        Phone: <%= address.phone %>, 
                        Email: <%= address.email %>, 
                        City: <%= address.city %>, 
                        District: <%= address.district %>, 
                        State: <%= address.state %>, 
                        Pincode: <%= address.pincode %>
                      </textarea>
                                                </div>
                                            </div>
                                            <% }); %>
                                                <% } %>
                                </div>
                                <%}else{%>
                                    <div class="row" id="addresslist">

                                    </div>

                                    <%}%>
                                        <h3>Address for Delivery</h3>
                                        <%if(addresses){%>
                                            <form class="row contact_form" action="" method="post" id="addressform">
                                                <input type="hidden" id="addressId1" name="addressId"
                                                    value="<%=addresses.address[0]._id%>" />

                                                <div class="col-md-6 form-group p_star">
                                                    <input type="text" class="form-control" id="name" name="name"
                                                        placeholder="Name" value="<%=addresses.address[0].name%>"
                                                        readonly />
                                                </div>

                                                <div class="col-md-6 form-group p_star">
                                                    <input type="text" class="form-control" id="number" name="number"
                                                        placeholder="Phone" value="<%=addresses.address[0].phone%>"
                                                        readonly />
                                                </div>
                                                <div class="col-md-6 form-group p_star">
                                                    <input type="email" class="form-control" id="email" name="email"
                                                        placeholder="Email" value="<%=addresses.address[0].email%>"
                                                        readonly />
                                                </div>

                                                <div class="col-md-12 form-group p_star">
                                                    <input type="text" class="form-control" id="city" name="city"
                                                        placeholder="City" value="<%=addresses.address[0].city%>"
                                                        readonly />
                                                </div>
                                                <div class="col-md-12 form-group p_star">
                                                    <input type="text" class="form-control" id="district"
                                                        name="district" placeholder="District"
                                                        value="<%=addresses.address[0].district%>" readonly />
                                                </div>
                                                <div class="col-md-12 form-group p_star">
                                                    <input type="text" class="form-control" id="state" name="state"
                                                        placeholder="State" value="<%=addresses.address[0].state%>"
                                                        readonly />
                                                </div>

                                                <div class="col-md-12 form-group p_star">
                                                    <input type="text" class="form-control" id="pincode" name="pincode"
                                                        placeholder="Pincode" value="<%=addresses.address[0].pincode%>"
                                                        readonly />

                                                </div>
                                            </form>
                                            <%}else{%>
                                                <form class="row contact_form" action="" method="post" id="addressform">
                                                    <input type="hidden" id="addressId" name="addressId" value="" />

                                                    <div class="col-md-6 form-group p_star">
                                                        <input type="text" class="form-control" id="name" name="name"
                                                            placeholder="Name" value="" readonly />
                                                    </div>

                                                    <div class="col-md-6 form-group p_star">
                                                        <input type="text" class="form-control" id="number"
                                                            name="number" placeholder="Phone" value="" readonly />
                                                    </div>
                                                    <div class="col-md-6 form-group p_star">
                                                        <input type="email" class="form-control" id="email" name="email"
                                                            placeholder="Email" value="" readonly />
                                                    </div>

                                                    <div class="col-md-12 form-group p_star">
                                                        <input type="text" class="form-control" id="city" name="city"
                                                            placeholder="City" value="" readonly />
                                                    </div>
                                                    <div class="col-md-12 form-group p_star">
                                                        <input type="text" class="form-control" id="district"
                                                            name="district" placeholder="District" value="" readonly />
                                                    </div>
                                                    <div class="col-md-12 form-group p_star">
                                                        <input type="text" class="form-control" id="state" name="state"
                                                            placeholder="State" value="" readonly />
                                                    </div>

                                                    <div class="col-md-12 form-group p_star">
                                                        <input type="text" class="form-control" id="pincode"
                                                            name="pincode" placeholder="Pincode" value="" readonly />

                                                    </div>
                                                </form>
                                                <%}%>


                                                    <form id="addanotheraddress">
                                                        <button class="btn_1" type="button" data-toggle="modal"
                                                            data-target="#addressModal">
                                                            Add another address
                                                        </button>
                                                    </form>

                        </div>
                        <div class="col-lg-5">
                            <div class="order_box">
                                <h2>Your Order</h2>
                                <input type="hidden" id="totalprice" value="<%=cartData.totalPrice%>">
                                <input type="hidden" id="cartid" value="<%=cartData.cartId%>">
                                <ul class="list">
                                    <li>
                                        <a>Product
                                            <span>Total</span>
                                        </a>
                                    </li>
                                    <%cartData.items.forEach(item=>{%>
                                        <li>
                                            <a>
                                                <%=item.productName%>
                                                    <span class="middle">x<%=item.quantity%></span>
                                                    <span class="last">₹<%=item.totalPrice%></span>
                                            </a>
                                        </li>
                                        <%})%>

                                </ul>
                                <ul class="list list_2">
                                    <li>
                                        <a href="#">Subtotal
                                            <span></span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#">Shipping
                                            <span>Flat rate: ₹0.00</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#">Total
                                            <span>₹<span id="totalcouponamount">
                                                    <%=cartData.totalPrice%>
                                                </span></span>
                                        </a>
                                    </li>
                                </ul>
                                <div class="payment_item">
                                    <p>
                                        Please send a check to Store Name, Store Street, Store Town,
                                        Store State / County, Store Postcode.
                                        Please send a check to Store Name, Store Street, Store Town,
                                        Store State / County, Store Postcode.
                                        Please send a check to Store Name, Store Street, Store Town,
                                        Store State / County, Store Postcode.
                                        Please send a check to Store Name, Store Street, Store Town,
                                        Store State / County, Store Postcode.
                                    </p>
                                    <div class="radion_btn">
                                        <input type="radio" id="f-option5" name="paymentMethod"
                                            value="Cash On Delivery" />
                                        <label for="f-option5">Cash On Delivery</label>
                                        <div class="check"></div>
                                    </div>


                                </div>
                                <div class="text-danger" id="codtext" style="display: none;">cash on delivery is only
                                    available when the total price is below ₹ 5000</div>
                                <div class="payment_item active">
                                    <div class="radion_btn">
                                        <input type="radio" id="f-option6" name="paymentMethod" value="Wallet" />
                                        <label for="f-option6">Wallet </label>
                                        <img src="img/product/single-product/card.jpg" alt="" />
                                        <div class="check"></div>
                                    </div>
                                    <!-- <p>
                                        Please send a check to Store Name, Store Street, Store Town,
                                        Store State / County, Store Postcode.
                                    </p> -->
                                </div>
                                <div class="payment_item active">
                                    <div class="radion_btn">
                                        <input type="radio" id="f-option7" name="paymentMethod" value="RazorPay" />
                                        <label for="f-option7">Razorpay </label>
                                        <img src="img/product/single-product/card.jpg" alt="" />
                                        <div class="check"></div>
                                    </div>
                                    <!-- <p>
                                        Please send a check to Store Name, Store Street, Store Town,
                                        Store State / County, Store Postcode.
                                    </p> -->
                                </div>
                                <div class="creat_account">
                                    <input type="checkbox" id="f-option4" name="selector" />
                                    <label for="f-option4">I’ve read and accept the </label>
                                    <a href="#">terms & conditions*</a>
                                </div>
                                <!-- <a class="btn_3" href="#">Proceed to Pay</a> -->
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <form action="" id="payform">
                                        <!-- <a style="color: aliceblue;" class="btn_3" onclick="submitForm()">Proceed to pay</a> -->
                                        <button class="btn_3" type="submit">proceed to pay</button>
                                    </form>

                                    <div style="margin-top: 20px; width: 53%;">
                                        <a class="btn_3" href="/user/cart" style="margin-left: 10 px;">Cancel</a>
                                    </div>
                                </div>
                                <div class="text-danger" id="addpayment" style="display: none;">add a payment method
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!--================End Checkout Area =================-->
        <!-- modal -->
        <div class="modal fade" id="addressModal" tabindex="-1" role="dialog" aria-labelledby="addressModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addressModalLabel">Add New Address</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">

                        <%if(addresses){%>
                            <form class="row contact_form" action="" method="post" id="addressform">
                                <input type="hidden" id="addressId" name="addressId" value="<%=addresses._id%>" />

                                <div class="col-md-6 form-group p_star">
                                    <input type="text" class="form-control" id="modalName" name="name"
                                        placeholder="Name" value="<%=addresses.address[0].name%>" />
                                </div>

                                <div class="col-md-6 form-group p_star">
                                    <input type="text" class="form-control" id="modalPhone" name="number"
                                        placeholder="Phone" value="<%=addresses.address[0].phone%>" />
                                </div>
                                <div class="col-md-6 form-group p_star">
                                    <input type="email" class="form-control" id="modalEmail" name="email"
                                        placeholder="Email" value="<%=addresses.address[0].email%>" />
                                </div>

                                <div class="col-md-12 form-group p_star">
                                    <input type="text" class="form-control" id="modalCity" name="city"
                                        placeholder="City" value="<%=addresses.address[0].city%>" />
                                </div>
                                <div class="col-md-12 form-group p_star">
                                    <input type="text" class="form-control" id="modalDistrict" name="district"
                                        placeholder="District" value="<%=addresses.address[0].district%>" />
                                </div>
                                <div class="col-md-12 form-group p_star">
                                    <input type="text" class="form-control" id="modalState" name="state"
                                        placeholder="State" value="<%=addresses.address[0].state%>" />
                                </div>

                                <div class="col-md-12 form-group p_star">
                                    <input type="text" class="form-control" id="modalPincode" name="pincode"
                                        placeholder="Pincode" value="<%=addresses.address[0].pincode%>" />

                                </div>
                            </form>
                            <%} else{%>
                                <form class="row contact_form" action="" method="post" id="addressform">
                                    <input type="hidden" id="addressId" name="addressId" value="" />

                                    <div class="col-md-6 form-group p_star">
                                        <input type="text" class="form-control" id="modalName" name="name"
                                            placeholder="Name" value="" />
                                    </div>

                                    <div class="col-md-6 form-group p_star">
                                        <input type="text" class="form-control" id="modalPhone" name="number"
                                            placeholder="Phone" value="" />
                                    </div>
                                    <div class="col-md-6 form-group p_star">
                                        <input type="email" class="form-control" id="modalEmail" name="email"
                                            placeholder="Email" value="" />
                                    </div>

                                    <div class="col-md-12 form-group p_star">
                                        <input type="text" class="form-control" id="modalCity" name="city"
                                            placeholder="City" value="" />
                                    </div>
                                    <div class="col-md-12 form-group p_star">
                                        <input type="text" class="form-control" id="modalDistrict" name="district"
                                            placeholder="District" value="" />
                                    </div>
                                    <div class="col-md-12 form-group p_star">
                                        <input type="text" class="form-control" id="modalState" name="state"
                                            placeholder="State" value="" />
                                    </div>

                                    <div class="col-md-12 form-group p_star">
                                        <input type="text" class="form-control" id="modalPincode" name="pincode"
                                            placeholder="Pincode" value="" />

                                    </div>
                                </form>
                                <%}%>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn_1" data-dismiss="modal">Close</button>
                        <button type="button" class="btn_1" id="saveAddressBtn">Save Address</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- jQuery and Bootstrap JS -->

        <!-- modal -->
        <!--::footer_part start::-->
        <footer class="footer_part">
            <div class="container">
                <div class="row justify-content-around">
                    <div class="col-sm-6 col-lg-2">
                        <div class="single_footer_part">
                            <h4>Top Products</h4>
                            <ul class="list-unstyled">
                                <li><a href="">Managed Website</a></li>
                                <li><a href="">Manage Reputation</a></li>
                                <li><a href="">Power Tools</a></li>
                                <li><a href="">Marketing Service</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-2">
                        <div class="single_footer_part">
                            <h4>Quick Links</h4>
                            <ul class="list-unstyled">
                                <li><a href="">Jobs</a></li>
                                <li><a href="">Brand Assets</a></li>
                                <li><a href="">Investor Relations</a></li>
                                <li><a href="">Terms of Service</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-2">
                        <div class="single_footer_part">
                            <h4>Features</h4>
                            <ul class="list-unstyled">
                                <li><a href="">Jobs</a></li>
                                <li><a href="">Brand Assets</a></li>
                                <li><a href="">Investor Relations</a></li>
                                <li><a href="">Terms of Service</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-2">
                        <div class="single_footer_part">
                            <h4>Resources</h4>
                            <ul class="list-unstyled">
                                <li><a href="">Guides</a></li>
                                <li><a href="">Research</a></li>
                                <li><a href="">Experts</a></li>
                                <li><a href="">Agencies</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-4">
                        <div class="single_footer_part">
                            <h4>Newsletter</h4>
                            <p>Heaven fruitful doesn't over lesser in days. Appear creeping
                            </p>
                            <div id="mc_embed_signup">
                                <form target="_blank"
                                    action="https://spondonit.us12.list-manage.com/subscribe/post?u=1462626880ade1ac87bd9c93a&amp;id=92a4423d01"
                                    method="get" class="subscribe_form relative mail_part">
                                    <input type="email" name="email" id="newsletter-form-email"
                                        placeholder="Email Address" class="placeholder hide-on-focus"
                                        onfocus="this.placeholder = ''" onblur="this.placeholder = ' Email Address '">
                                    <button type="submit" name="submit" id="newsletter-submit"
                                        class="email_icon newsletter-submit button-contactForm">subscribe</button>
                                    <div class="mt-10 info"></div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="copyright_part">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="copyright_text">
                                <P><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                                    Copyright &copy;
                                    <script>document.write(new Date().getFullYear());</script> All rights reserved |
                                    This template is made with <i class="ti-heart" aria-hidden="true"></i> by <a
                                        href="https://colorlib.com" target="_blank">Colorlib</a>
                                    <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                                </P>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="footer_icon social_icon">
                                <ul class="list-unstyled">
                                    <li><a href="#" class="single_social_icon"><i class="fab fa-facebook-f"></i></a>
                                    </li>
                                    <li><a href="#" class="single_social_icon"><i class="fab fa-twitter"></i></a></li>
                                    <li><a href="#" class="single_social_icon"><i class="fas fa-globe"></i></a></li>
                                    <li><a href="#" class="single_social_icon"><i class="fab fa-behance"></i></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <!--::footer_part end::-->
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

        <script>

            async function applyCoupon(totalPrice) {
                console.log('clicked')

                const coupon = document.getElementById('coupon')
                const couponValid = document.getElementById('couponValidation')
                const totalcouponamount = document.getElementById('totalcouponamount')
                console.log(totalcouponamount)
                console.log('the button clicked')
                if (!coupon.value || coupon.value === '') {
                    couponValid.textContent = 'coupon code is not valid'
                    return
                } else {
                    couponValid.textContent = ''
                }
                try {
                    const couponCode = coupon.value
                    const response = await fetch('/user/coupons/apply-coupon', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ couponCode, totalPrice })
                    })
                    const result = await response.json()
                    if (response.ok) {
                        const resultantPrice = result.totalPrice
                        totalcouponamount.textContent = `${resultantPrice}`
                        Swal.fire({
                            title: 'success',
                            text: 'applied your discount see the new price !',
                            icon: 'success',
                            confirmButtonText: 'OK'

                        })
                        console.log('response is ok')
                    } else {
                        couponValid.textContent = result.message
                        return
                    }
                } catch (err) {
                    console.error(err)
                }

            }
        </script>
        <script>

            document.addEventListener('DOMContentLoaded', async () => {

                let formData = {}
                const addressList = document.getElementById('addresslist');
                const saveAddressBtn = document.getElementById('saveAddressBtn');
                const payForm = document.getElementById('payform');

                addressList.addEventListener('change', async (event) => {
                    const targetRadio = event.target;
                    if (targetRadio.matches('input[name="selectedAddress"]')) {
                        console.log('this is name:', targetRadio.dataset.name)
                        console.log('this is id:', targetRadio.dataset.id)
                        const something = document.getElementById('addressId1')
                        console.log('this is addressId1', something)
                        document.getElementById('addressId').value = targetRadio.dataset.id
                        document.getElementById('name').value = targetRadio.dataset.name || '';
                        document.getElementById('number').value = targetRadio.dataset.phone || '';
                        document.getElementById('email').value = targetRadio.dataset.email || '';
                        document.getElementById('city').value = targetRadio.dataset.city || '';
                        document.getElementById('district').value = targetRadio.dataset.district || '';
                        document.getElementById('state').value = targetRadio.dataset.state || '';
                        document.getElementById('pincode').value = targetRadio.dataset.pin || '';
                    }


                });

                document.getElementById('saveAddressBtn').addEventListener('click', async (event) => {
                    event.preventDefault()
                    const name = document.getElementById('modalName').value;
                    const number = document.getElementById('modalPhone').value;
                    const email = document.getElementById('modalEmail').value;
                    const city = document.getElementById('modalCity').value;
                    const district = document.getElementById('modalDistrict').value;
                    const state = document.getElementById('modalState').value;
                    const pin = document.getElementById('modalPincode').value;
                    formData = {
                        name, number, email, city, district, state, pin
                    }
                    console.log(formData)
                    const response = await fetch('/user/dashboard/profile/address/addaddress', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    })
                    const result = await response.json()
                    if (response.ok) {
                        Swal.fire({
                            title: 'success',
                            text: result.message,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            console.log(result.addressdata)
                            const addressId = result.addressdata.address[result.addressdata.address.length - 1]._id
                            const newAddress = `
                    <div class="col-md-6">
                        <div class="address-item mb-3 d-flex align-items-start">
                            <input type="radio" name="selectedAddress" value="${addressId}" class="mr-2" data-id="${addressId}" data-name="${name}" data-phone="${number}" data-email="${email}" data-city="${city}" data-district="${district}" data-state="${state}" data-pincode="${pin}">
                            <textarea class="form-control" rows="3" style="height: 200px;" readonly>
                                Name: ${name}, 
                                Phone: ${number}, 
                                Email: ${email}, 
                                City: ${city}, 
                                District: ${district}, 
                                State: ${state}, 
                                Pincode: ${pin}
                            </textarea>
                        </div>
                    </div>
                `;

                            document.getElementById('addresslist').insertAdjacentHTML('beforeend', newAddress);
                            $('#addressModal').modal('hide').on('hidden.bs.modal', function () {
                                $('.modal-backdrop').remove();
                            });
                        })
                    } else {
                        Swal.fire({
                            title: 'failed',
                            text: result.message,
                            icon: 'failed',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            $('#addressModal').modal('hide').on('hidden.bs.modal', function () {
                                $('.modal-backdrop').remove();
                            });
                        })
                    }
                });

                const codRadio = document.getElementById('f-option5')
                const codWallet = document.getElementById('f-option6')
                const codRazorPay = document.getElementById('f-option7')
                const totalPrice = document.getElementById('totalprice')
                const codText = document.getElementById('codtext')
                codRadio.addEventListener('change', async (event) => {
                    event.preventDefault()
                    if (Number(totalPrice.value) > 5000) {
                        codText.style.display = 'inline'

                    } else {
                        codText.style.display = 'none'
                        addPayment.style.display = 'none'
                    }
                })
                codRazorPay.addEventListener('change', async (event) => {
                    event.preventDefault()
                    codText.style.display = 'none'
                    addPayment.style.display = 'none'
                })
                codWallet.addEventListener('change', async (event) => {
                    event.preventDefault()
                    codText.style.display = 'none'
                    addPayment.style.display = 'none'
                })
                const addPayment = document.getElementById('addpayment')
                payForm.addEventListener('submit', async (event) => {
                    event.preventDefault()
                    if (!document.querySelector('input[name="paymentMethod"]:checked')) {
                        addPayment.style.display = 'inline'
                        return
                    } else {
                        addPayment.style.display = 'none'
                    }
                    const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                    if (selectedPaymentMethod === 'Cash On Delivery' && totalPrice.value > 5000) {
                        codText.style.display = 'inline'
                        return

                    }

                    if (selectedPaymentMethod === 'Cash On Delivery') {
                        const swalResult = await Swal.fire({
                            title: 'confirm',
                            text: 'Are you sure to proceed to place order ',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Ok',
                            cancelButtonText: 'Cancel'
                        })
                        if (!swalResult.isConfirmed) {
                            return
                        }
                        const addressId = document.getElementById('addressId').value
                        if (!addressId) {
                            Toastify({
                                text: "Address is not added",
                                duration: 3000,
                                close: true, 
                                gravity: "bottom", 
                                position: "center", 
                                backgroundColor: "linear-gradient(to right, #ff5722, #ff8a00)", 
                                stopOnFocus: true, 
                            }).showToast();
                            return
                        }
                        console.log(addressId)
                        const cartId = document.getElementById('cartid').value
                        const totalAmount = parseInt(document.getElementById('totalcouponamount').textContent, 10)
                        const paymentMethod = selectedPaymentMethod
                        orderData = {
                            addressId, cartId, totalAmount, paymentMethod
                        }
                        console.log(orderData)


                        const response = await fetch('/user/cart/checkout/order-cashondelivery', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(orderData)
                        })

                        const result = await response.json()
                        if (response.ok) {
                            Swal.fire({
                                title: 'success',
                                text: result.message,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.href = '/user/cart/checkout/order-cashondelivery/order-success'
                            })
                        } else {
                            if (result.status === 400) {
                                Swal.fire({
                                    title: 'failed',
                                    text: result.message,
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                }).then(() => {
                                    window.location.reload()
                                })
                            }
                            Swal.fire({
                                title: 'failed',
                                text: result.message,
                                icon: 'error',
                                confirmButtonText: 'OK'
                            })
                        }
                    } else if (selectedPaymentMethod === 'RazorPay') {
                        console.log('razorpay selected')
                        const addressId = document.getElementById('addressId').value
                        if (!addressId) {
                            Toastify({
                                text: "Address is not added",
                                duration: 3000,
                                close: true, 
                                gravity: "top", 
                                position: "center", 
                                backgroundColor: "linear-gradient( #ff3368, #ff3368)",
                                stopOnFocus: true, 
                            }).showToast();
                            return
                        }
                        const cartId = document.getElementById('cartid').value
                        const totalAmount = document.getElementById('totalcouponamount').textContent
                        console.log('totalamount is:', totalAmount)
                        const paymentMethod = selectedPaymentMethod
                        console.log(formData)
                        orderData = {
                            addressId, cartId, totalAmount, paymentMethod
                        }
                        console.log(orderData)
                        const response = await fetch('/user/online-payment/razorpay/create-order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                amount: totalAmount * 100,
                                currency: 'INR',

                            })
                        })
                        const order = await response.json()
                        console.log(order.amount)
                        const options = {
                            "key": 'rzp_test_t6lNXNWWwp0wq6',
                            "amount": (order.amount),
                            "currency": order.currency,
                            "name": "Aranoz",
                            "description": " Transaction",
                            "image": "https://yourlogo.com/logo.png",
                            "order_id": order.id,
                            "handler": function (response) {
                                fetch('/user/online-payment/razorpay/verify-payment', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        razorpay_order_id: response.razorpay_order_id,
                                        razorpay_payment_id: response.razorpay_payment_id,
                                        razorpay_signature: response.razorpay_signature,
                                        orderData
                                    })
                                }).then(response => response.json())
                                    .then(data => {
                                        if (data.message === 'verification success') {
                                            window.location.href = '/user/cart/checkout/order-cashondelivery/order-success'
                                        } else {
                                            alert('Payment verification failed');
                                        }
                                    }).catch(error => {
                                        console.error(error);
                                    });
                            },


                            "prefill": {
                                "name": "Test User",
                                "email": "test.user@example.com",
                                "contact": "9999999999"
                            },
                            "notes": {
                                "address": "Razorpay Corporate Office"
                            },
                            "theme": {
                                "color": "#ff3368"
                            },

                        };

                        const rzp1 = new Razorpay(options);
                        rzp1.open();
                        rzp1.on('payment.failed', async (response) => {
                            console.log('this is response', response)
                            fetch('/user/online-payment/razorpay/error/verify-payment', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_signature: response.razorpay_signature,
                                    orderData
                                })
                            }).then(response => response.json())
                                .then(data => {
                                    if (data.message === 'verification success') {
                                        window.location.href = '/user/cart/checkout/order-cashondelivery/order-success'
                                    } else if (data.message === 'verification failed') {

                                        alert('Payment verification failed');
                                    }
                                }).catch(error => {
                                    console.error(error);
                                });
                        })
                    } else if (selectedPaymentMethod === 'Wallet') {
                        const swalResult = await Swal.fire({
                            title: 'confirm',
                            text: 'Are you sure to proceed to place order ',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Ok',
                            cancelButtonText: 'Cancel'
                        })
                        if (!swalResult.isConfirmed) {
                            return
                        }
                        const addressId = document.getElementById('addressId').value
                        console.log(addressId)
                        if (!addressId) {
                            Toastify({
                                text: "Address is not added",
                                duration: 3000,
                                close: true, 
                                gravity: "bottom", 
                                position: "center", 
                                backgroundColor: "linear-gradient(to right, #ff5722, #ff8a00)",

                                stopOnFocus: true, 
                            }).showToast();
                            return
                        }
                        const cartId = document.getElementById('cartid').value
                        const totalAmount = parseInt(document.getElementById('totalcouponamount').textContent, 10)
                        const paymentMethod = selectedPaymentMethod
                        orderData = {
                            addressId, cartId, totalAmount, paymentMethod
                        }
                        console.log(orderData)
                        const response = await fetch('/user/cart/checkout/order-wallet', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(orderData)
                        })
                        const result = await response.json()
                        if (response.ok) {
                            Swal.fire({
                                title: 'success',
                                text: result.message,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.href = '/user/cart/checkout/order-wallet/order-success'
                            })
                        } else {
                            if (result.status === 400) {
                                Swal.fire({
                                    title: 'failed',
                                    text: result.message,
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                }).then(() => {
                                    window.location.reload()
                                })
                            } else if (result.status === 404) {
                                Swal.fire({
                                    title: 'failed',
                                    text: result.message,
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                })
                            }
                            Swal.fire({
                                title: 'failed',
                                text: result.message,
                                icon: 'error',
                                confirmButtonText: 'OK'
                            })
                        }
                    }


                })

            })
        </script>
         <script>
            async function logout() {
    
                try {
                    const response = await fetch('/user/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    const data = await response.json()
    
                    if (response.ok) {
                        window.location.href = '/'
                    } else {
                        Swal.fire({
                            title: 'failed',
                            text: data.message,
                            icon: 'failed',
                            confirmButtonText: 'OK'
                        })
                    }
                } catch (err) {
                    console.log('error in logout')
                    Swal.fire({
                        title: 'failed',
                        text: 'error in logout',
                        icon: 'failed',
                        confirmButtonText: 'OK'
                    })
                }
            }
        </script>
        <!-- jquery plugins here-->
        <!-- jquery -->
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
        <script src="/js/jquery-1.12.1.min.js"></script>
        <!-- popper js -->
        <script src="/js/popper.min.js"></script>
        <!-- bootstrap js -->
        <script src="/js/bootstrap.min.js"></script>
        <!-- easing js -->
        <script src="/js/jquery.magnific-popup.js"></script>
        <!-- swiper js -->
        <script src="/js/swiper.min.js"></script>
        <!-- swiper js -->
        <script src="/js/masonry.pkgd.js"></script>
        <!-- particles js -->
        <script src="/js/owl.carousel.min.js"></script>
        <script src="/js/jquery.nice-select.min.js"></script>
        <!-- slick js -->
        <script src="/js/slick.min.js"></script>
        <script src="/js/jquery.counterup.min.js"></script>
        <script src="/js/waypoints.min.js"></script>
        <script src="/js/contact.js"></script>
        <script src="/js/jquery.ajaxchimp.min.js"></script>
        <script src="/js/jquery.form.js"></script>
        <script src="/js/jquery.validate.min.js"></script>
        <script src="/js/mail-script.js"></script>
        <script src="/js/stellar.js"></script>
        <script src="/js/price_rangs.js"></script>
        <!-- custom js -->
        <script src="js/custom.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

        <% include ('../usersidepartials/footer')%>